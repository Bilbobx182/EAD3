{"version":3,"sources":["../src/index.js"],"names":["ensureValidPlugins","name","arr","Array","isArray","Error","i","l","length","fn","inflections","postGraphQLBaseOverrides","enumName","value","defaultUtils","constantCase","defaultInflection","postGraphQLClassicIdsOverrides","column","_table","_schema","camelCase","postGraphQLInflection","newInflector","postGraphQLClassicIdsInflection","awaitKeys","obj","result","k","getPostGraphQLBuilder","pgConfig","schemas","options","dynamicJson","classicIds","nodeIdFieldName","replaceAllPlugins","appendPlugins","prependPlugins","skipPlugins","jwtPgTypeIdentifier","jwtSecret","disableDefaultMutations","graphileBuildOptions","graphqlBuildOptions","inflector","pgColumnFilter","viewUniqueKey","enableTags","readCache","writeCache","setWriteCacheCallback","persistentMemoizeWithKey","undefined","memoizeCache","JSON","parse","resolve","reject","readFile","err","data","key","then","writeFile","filter","p","indexOf","pgSchemas","pgExtendedTypes","pgInflection","pgJwtTypeIdentifier","pgJwtSecret","pgDisableDefaultMutations","pgViewUniqueKey","pgEnableTags","abort","e","console","error","process","exit","createPostGraphQLSchema","builder","schema","buildSchema","catch","watchPostGraphQLSchema","onNewSchema","released","handleNewSchema","args","watchSchema","release","unwatchSchema","postGraphileBaseOverrides","postGraphileClassicIdsOverrides","postGraphileInflection","postGraphileClassicIdsInflection","createPostGraphileSchema","watchPostGraphileSchema"],"mappings":"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","file":"index.js","sourcesContent":["// @flow\nimport fs from \"fs\";\nimport { defaultPlugins, getBuilder } from \"graphile-build\";\nimport {\n  defaultPlugins as pgDefaultPlugins,\n  inflections,\n  Inflector,\n} from \"graphile-build-pg\";\nimport type { Pool, Client } from \"pg\";\nimport type { Plugin, Options, SchemaListener } from \"graphile-build\";\nimport type { Build, Context } from \"graphile-build\";\n\nconst ensureValidPlugins = (name, arr) => {\n  if (!Array.isArray(arr)) {\n    throw new Error(`Option '${name}' should be an array`);\n  }\n  for (let i = 0, l = arr.length; i < l; i++) {\n    const fn = arr[i];\n    if (typeof fn !== \"function\") {\n      throw new Error(\n        `Option '${name}' should be an array of functions, found '${typeof fn}' at index ${i}`\n      );\n    }\n  }\n};\n\ntype PostGraphQLOptions = {\n  dynamicJson?: boolean,\n  classicIds?: boolean,\n  disableDefaultMutations?: string,\n  nodeIdFieldName?: string,\n  graphileBuildOptions?: Options,\n  graphqlBuildOptions?: Options, // DEPRECATED!\n  replaceAllPlugins?: Array<Plugin>,\n  appendPlugins?: Array<Plugin>,\n  prependPlugins?: Array<Plugin>,\n  skipPlugins?: Array<Plugin>,\n  jwtPgTypeIdentifier?: string,\n  jwtSecret?: string,\n  inflector?: Inflector,\n  pgColumnFilter?: (mixed, Build, Context) => boolean,\n  viewUniqueKey?: string,\n  enableTags?: boolean,\n  readCache?: string,\n  writeCache?: string,\n  setWriteCacheCallback?: (fn: () => Promise<void>) => void,\n};\n\ntype PgConfig = Client | Pool | string;\n\nexport { inflections };\n\nexport const postGraphQLBaseOverrides = {\n  enumName(value: string) {\n    return inflections.defaultUtils.constantCase(\n      inflections.defaultInflection.enumName(value)\n    );\n  },\n};\n\nexport const postGraphQLClassicIdsOverrides = {\n  column(name: string, _table: string, _schema: ?string) {\n    return name === \"id\" ? \"rowId\" : inflections.defaultUtils.camelCase(name);\n  },\n};\n\nexport const postGraphQLInflection = inflections.newInflector(\n  postGraphQLBaseOverrides\n);\nexport const postGraphQLClassicIdsInflection = inflections.newInflector(\n  Object.assign({}, postGraphQLBaseOverrides, postGraphQLClassicIdsOverrides)\n);\n\nconst awaitKeys = async obj => {\n  const result = {};\n  for (const k in obj) {\n    result[k] = await obj[k];\n  }\n  return result;\n};\n\nconst getPostGraphQLBuilder = async (\n  pgConfig,\n  schemas,\n  options: PostGraphQLOptions = {}\n) => {\n  const { dynamicJson, classicIds, nodeIdFieldName } = options;\n  const {\n    replaceAllPlugins,\n    appendPlugins = [],\n    prependPlugins = [],\n    skipPlugins = [],\n    jwtPgTypeIdentifier,\n    jwtSecret,\n    disableDefaultMutations,\n    graphileBuildOptions,\n    graphqlBuildOptions, // DEPRECATED!\n    inflector,\n    pgColumnFilter,\n    viewUniqueKey,\n    enableTags = true,\n    readCache,\n    writeCache,\n    setWriteCacheCallback,\n  } = options;\n  if (replaceAllPlugins) {\n    ensureValidPlugins(\"replaceAllPlugins\", replaceAllPlugins);\n    if (\n      (prependPlugins && prependPlugins.length) ||\n      (appendPlugins && appendPlugins.length)\n    ) {\n      throw new Error(\n        \"When using 'replaceAllPlugins' you must not specify 'appendPlugins'/'prependPlugins'\"\n      );\n    }\n  }\n  if (readCache && writeCache) {\n    throw new Error(\"Use `readCache` or `writeCache` - not both.\");\n  }\n\n  let persistentMemoizeWithKey = undefined; // NOT null, otherwise it won't default correctly.\n  let memoizeCache = {};\n\n  if (readCache) {\n    memoizeCache = JSON.parse(\n      await new Promise((resolve, reject) => {\n        fs.readFile(readCache, \"utf8\", (err, data) => {\n          if (err) {\n            reject(err);\n          } else {\n            resolve(data);\n          }\n        });\n      })\n    );\n  }\n  if (readCache || writeCache) {\n    persistentMemoizeWithKey = (key, fn) => {\n      if (!(key in memoizeCache)) {\n        if (readCache) {\n          throw new Error(`Expected cache to contain key: ${key}`);\n        }\n        memoizeCache[key] = fn();\n        if (memoizeCache[key] === undefined) {\n          throw new Error(`Cannot memoize 'undefined' - use 'null' instead`);\n        }\n      }\n      return memoizeCache[key];\n    };\n  }\n\n  if (writeCache && setWriteCacheCallback) {\n    setWriteCacheCallback(() =>\n      awaitKeys(memoizeCache).then(\n        obj =>\n          new Promise((resolve, reject) => {\n            fs.writeFile(writeCache, JSON.stringify(obj), err => {\n              memoizeCache = {};\n              if (err) {\n                reject(err);\n              } else {\n                resolve();\n              }\n            });\n          })\n      )\n    );\n  } else if (writeCache) {\n    throw new Error(\"Cannot write cache without 'setWriteCacheCallback'\");\n  } else if (setWriteCacheCallback) {\n    setWriteCacheCallback(() => Promise.resolve());\n  }\n\n  ensureValidPlugins(\"prependPlugins\", prependPlugins);\n  ensureValidPlugins(\"appendPlugins\", appendPlugins);\n  ensureValidPlugins(\"skipPlugins\", skipPlugins);\n  return getBuilder(\n    (replaceAllPlugins\n      ? [...prependPlugins, ...replaceAllPlugins, ...appendPlugins]\n      : [\n          ...prependPlugins,\n          ...defaultPlugins,\n          ...pgDefaultPlugins,\n          ...appendPlugins,\n        ]\n    ).filter(p => skipPlugins.indexOf(p) === -1),\n    Object.assign(\n      {\n        pgConfig: pgConfig,\n        pgSchemas: Array.isArray(schemas) ? schemas : [schemas],\n        pgExtendedTypes: !!dynamicJson,\n        pgColumnFilter: pgColumnFilter || (() => true),\n        pgInflection:\n          inflector ||\n          (classicIds\n            ? postGraphQLClassicIdsInflection\n            : postGraphQLInflection),\n        nodeIdFieldName: nodeIdFieldName || (classicIds ? \"id\" : \"nodeId\"),\n        pgJwtTypeIdentifier: jwtPgTypeIdentifier,\n        pgJwtSecret: jwtSecret,\n        pgDisableDefaultMutations: disableDefaultMutations,\n        pgViewUniqueKey: viewUniqueKey,\n        pgEnableTags: enableTags,\n        persistentMemoizeWithKey,\n      },\n      graphileBuildOptions,\n      graphqlBuildOptions // DEPRECATED!\n    )\n  );\n};\n\nfunction abort(e) {\n  /* eslint-disable no-console */\n  console.error(\"Error occured whilst writing cache\");\n  console.error(e);\n  process.exit(1);\n  /* eslint-enable */\n}\n\nexport const createPostGraphQLSchema = async (\n  pgConfig: PgConfig,\n  schemas: Array<string> | string,\n  options: PostGraphQLOptions = {}\n) => {\n  let writeCache;\n  const builder = await getPostGraphQLBuilder(\n    pgConfig,\n    schemas,\n    Object.assign({}, options, {\n      setWriteCacheCallback(fn) {\n        writeCache = fn;\n      },\n    })\n  );\n  const schema = builder.buildSchema();\n  if (writeCache) writeCache().catch(abort);\n  return schema;\n};\n\n/*\n * Unless an error occurs, `onNewSchema` is guaranteed to be called before this promise resolves\n */\nexport const watchPostGraphQLSchema = async (\n  pgConfig: PgConfig,\n  schemas: Array<string> | string,\n  options: PostGraphQLOptions = {},\n  onNewSchema: SchemaListener\n) => {\n  if (typeof onNewSchema !== \"function\") {\n    throw new Error(\n      \"You cannot call watchPostGraphQLSchema without a function to pass new schemas to\"\n    );\n  }\n  if (options.readCache) {\n    throw new Error(\"Using readCache in watch mode does not make sense.\");\n  }\n  let writeCache;\n  const builder = await getPostGraphQLBuilder(\n    pgConfig,\n    schemas,\n    Object.assign({}, options, {\n      setWriteCacheCallback(fn) {\n        writeCache = fn;\n      },\n    })\n  );\n  let released = false;\n  function handleNewSchema(...args) {\n    if (writeCache) writeCache().catch(abort);\n    onNewSchema(...args);\n  }\n  await builder.watchSchema(handleNewSchema);\n\n  return async function release() {\n    if (released) return;\n    released = true;\n    await builder.unwatchSchema();\n  };\n};\n\nexport const postGraphileBaseOverrides = postGraphQLBaseOverrides;\nexport const postGraphileClassicIdsOverrides = postGraphQLClassicIdsOverrides;\nexport const postGraphileInflection = postGraphQLInflection;\nexport const postGraphileClassicIdsInflection = postGraphQLClassicIdsInflection;\nexport const createPostGraphileSchema = createPostGraphQLSchema;\nexport const watchPostGraphileSchema = watchPostGraphQLSchema;\n"]}