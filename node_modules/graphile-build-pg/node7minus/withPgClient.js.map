{"version":3,"sources":["../src/withPgClient.js"],"names":["quacksLikePgPool","debug","constructorName","obj","constructor","name","quacksLikePgClient","pgConfig","connect","end","escapeLiteral","escapeIdentifier","Client","options","query","withPgClient","process","env","DATABASE_URL","fn","Error","releasePgClient","pgClient","result","release","Pool","pgPool","undefined","on","e","resolve","reject","err"],"mappings":"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","file":"withPgClient.js","sourcesContent":["// @flow\nimport pg from \"pg\";\nimport debugFactory from \"debug\";\nconst debug = debugFactory(\"graphile-build-pg\");\n\nfunction constructorName(obj) {\n  return obj && typeof obj.constructor === \"function\" && obj.constructor.name;\n}\n\n// Some duck-typing\n\nfunction quacksLikePgClient(pgConfig: mixed): boolean {\n  // A diagnosis of exclusion\n  if (!pgConfig || typeof pgConfig !== \"object\") return false;\n  if (constructorName(pgConfig) !== \"Client\") return false;\n  if (typeof pgConfig.connect !== \"function\") return false;\n  if (typeof pgConfig.end !== \"function\") return false;\n  if (typeof pgConfig.escapeLiteral !== \"function\") return false;\n  if (typeof pgConfig.escapeIdentifier !== \"function\") return false;\n  return true;\n}\n\nexport function quacksLikePgPool(pgConfig: mixed): boolean {\n  // A diagnosis of exclusion\n  if (!pgConfig || typeof pgConfig !== \"object\") return false;\n  if (\n    constructorName(pgConfig) !== \"Pool\" &&\n    constructorName(pgConfig) !== \"BoundPool\"\n  ) {\n    return false;\n  }\n  if (!pgConfig.Client) return false;\n  if (!pgConfig.options) return false;\n  if (typeof pgConfig.connect !== \"function\") return false;\n  if (typeof pgConfig.end !== \"function\") return false;\n  if (typeof pgConfig.query !== \"function\") return false;\n  return true;\n}\n\nconst withPgClient = async (\n  pgConfig: pg.Client | pg.Pool | string = process.env.DATABASE_URL,\n  fn: (pgClient: pg.Client) => *\n) => {\n  if (!fn) {\n    throw new Error(\"Nothing to do!\");\n  }\n  let releasePgClient = () => {};\n  let pgClient: pg.Client;\n  let result;\n  try {\n    if (pgConfig instanceof pg.Client || quacksLikePgClient(pgConfig)) {\n      pgClient = (pgConfig: pg.Client);\n      if (!pgClient.release) {\n        throw new Error(\n          \"We only support PG clients from a PG pool (because otherwise the `await` call can hang indefinitely if an error occurs and there's no error handler)\"\n        );\n      }\n    } else if (pgConfig instanceof pg.Pool || quacksLikePgPool(pgConfig)) {\n      const pgPool = (pgConfig: pg.Pool);\n      pgClient = await pgPool.connect();\n      releasePgClient = () => pgClient.release();\n    } else if (pgConfig === undefined || typeof pgConfig === \"string\") {\n      pgClient = new pg.Client(pgConfig);\n      pgClient.on(\"error\", e => {\n        debug(\"pgClient error occurred: %s\", e);\n      });\n      releasePgClient = () =>\n        new Promise((resolve, reject) =>\n          pgClient.end(err => (err ? reject(err) : resolve()))\n        );\n      await new Promise((resolve, reject) =>\n        pgClient.connect(err => (err ? reject(err) : resolve()))\n      );\n    } else {\n      throw new Error(\"You must provide a valid PG client configuration\");\n    }\n    result = await fn(pgClient);\n  } finally {\n    try {\n      await releasePgClient();\n    } catch (e) {\n      // Failed to release, assuming success\n    }\n  }\n  return result;\n};\n\nexport default withPgClient;\n"]}