{"version":3,"sources":["../../src/plugins/PgComputedColumnsPlugin.js"],"names":["PgComputedColumnsPlugin","builder","hook","fields","build","scope","isPgRowType","isPgCompoundType","isInputType","table","pgIntrospection","fieldWithHooks","Self","kind","namespace","extend","introspectionResultsByKind","pgIntrospectionResultsByKind","inflection","pgInflection","tableType","type","filter","namespaceId","classId","id","Error","procedure","proc","isStable","name","startsWith","argTypeIds","length","reduce","memo","argTypes","map","typeById","typeId","slice","some","class","isSelectable","pseudoColumnName","substr","fieldName","column","computed"],"mappings":";;;;;;AACA;;;;;;kBAIgB,SAASA,uBAAT,CAAiCC,OAAjC,EAA0C;AACxDA,UAAQC,IAAR,CACE,0BADF,EAEE,UACEC,MADF,EAEEC,KAFF,QAaK;AAAA,0BATDC,KASC;AAAA,QARCC,WAQD,cARCA,WAQD;AAAA,QAPCC,gBAOD,cAPCA,gBAOD;AAAA,QANCC,WAMD,cANCA,WAMD;AAAA,QALkBC,KAKlB,cALCC,eAKD;AAAA,QAHDC,cAGC,QAHDA,cAGC;AAAA,QAFDC,IAEC,QAFDA,IAEC;;AACH,QACEJ,eACA,EAAEF,eAAeC,gBAAjB,CADA,IAEA,CAACE,KAFD,IAGAA,MAAMI,IAAN,KAAe,OAHf,IAIA,CAACJ,MAAMK,SALT,EAME;AACA,aAAOX,MAAP;AACD;AATE,QAWDY,MAXC,GAcCX,KAdD,CAWDW,MAXC;AAAA,QAY6BC,0BAZ7B,GAcCZ,KAdD,CAYDa,4BAZC;AAAA,QAaaC,UAbb,GAcCd,KAdD,CAaDe,YAbC;;AAeH,QAAMC,YAAYJ,2BAA2BK,IAA3B,CAAgCC,MAAhC,CAChB;AAAA,aACED,KAAKA,IAAL,KAAc,GAAd,IACAA,KAAKE,WAAL,KAAqBd,MAAMc,WAD3B,IAEAF,KAAKG,OAAL,KAAiBf,MAAMgB,EAHzB;AAAA,KADgB,EAKhB,CALgB,CAAlB;AAMA,QAAI,CAACL,SAAL,EAAgB;AACd,YAAM,IAAIM,KAAJ,CAAU,6CAAV,CAAN;AACD;AACD,WAAOX,OACLZ,MADK,EAELa,2BAA2BW,SAA3B,CACGL,MADH,CACU;AAAA,aAAQM,KAAKC,QAAb;AAAA,KADV,EAEGP,MAFH,CAEU;AAAA,aAAQM,KAAKL,WAAL,KAAqBd,MAAMc,WAAnC;AAAA,KAFV,EAGGD,MAHH,CAGU;AAAA,aAAQM,KAAKE,IAAL,CAAUC,UAAV,CAAsB,GAAEtB,MAAMqB,IAAK,GAAnC,CAAR;AAAA,KAHV,EAIGR,MAJH,CAIU;AAAA,aAAQM,KAAKI,UAAL,CAAgBC,MAAhB,GAAyB,CAAjC;AAAA,KAJV,EAKGX,MALH,CAKU;AAAA,aAAQM,KAAKI,UAAL,CAAgB,CAAhB,MAAuBZ,UAAUK,EAAzC;AAAA,KALV,EAMGS,MANH,CAMU,UAACC,IAAD,EAAOP,IAAP,EAAgB;AACtB;;;;;;;;;;;;;;AAcA,UAAMQ,WAAWR,KAAKI,UAAL,CAAgBK,GAAhB,CACf;AAAA,eAAUrB,2BAA2BsB,QAA3B,CAAoCC,MAApC,CAAV;AAAA,OADe,CAAjB;AAGA,UACEH,SACGI,KADH,CACS,CADT,EAEGC,IAFH,CAGI;AAAA,eACEpB,KAAKA,IAAL,KAAc,GAAd,IAAqBA,KAAKqB,KAA1B,IAAmCrB,KAAKqB,KAAL,CAAWC,YADhD;AAAA,OAHJ,CADF,EAOE;AACA;AACA,eAAOR,IAAP;AACD;;AAED,UAAMS,mBAAmBhB,KAAKE,IAAL,CAAUe,MAAV,CAAiBpC,MAAMqB,IAAN,CAAWG,MAAX,GAAoB,CAArC,CAAzB;AACA,UAAMa,YAAY5B,WAAW6B,MAAX,CAChBH,gBADgB,EAEhBnC,MAAMqB,IAFU,EAGhBrB,MAAMK,SAAN,CAAgBgB,IAHA,CAAlB;AAKAK,WAAKW,SAAL,IAAkB,6BAAcA,SAAd,EAAyBlB,IAAzB,EAA+BxB,KAA/B,EAAsC;AACtDO,sBADsD;AAEtDqC,kBAAU;AAF4C,OAAtC,CAAlB;AAIA,aAAOb,IAAP;AACD,KA/CH,EA+CK,EA/CL,CAFK,EAkDJ,8BAA6BvB,KAAKkB,IAAK,GAlDnC,CAAP;AAoDD,GA3FH;AA6FD,C","file":"PgComputedColumnsPlugin.js","sourcesContent":["// @flow\nimport makeProcField from \"./makeProcField\";\n\nimport type { Plugin } from \"graphile-build\";\n\nexport default (function PgComputedColumnsPlugin(builder) {\n  builder.hook(\n    \"GraphQLObjectType:fields\",\n    (\n      fields,\n      build,\n      {\n        scope: {\n          isPgRowType,\n          isPgCompoundType,\n          isInputType,\n          pgIntrospection: table,\n        },\n        fieldWithHooks,\n        Self,\n      }\n    ) => {\n      if (\n        isInputType ||\n        !(isPgRowType || isPgCompoundType) ||\n        !table ||\n        table.kind !== \"class\" ||\n        !table.namespace\n      ) {\n        return fields;\n      }\n      const {\n        extend,\n        pgIntrospectionResultsByKind: introspectionResultsByKind,\n        pgInflection: inflection,\n      } = build;\n      const tableType = introspectionResultsByKind.type.filter(\n        type =>\n          type.type === \"c\" &&\n          type.namespaceId === table.namespaceId &&\n          type.classId === table.id\n      )[0];\n      if (!tableType) {\n        throw new Error(\"Could not determine the type for this table\");\n      }\n      return extend(\n        fields,\n        introspectionResultsByKind.procedure\n          .filter(proc => proc.isStable)\n          .filter(proc => proc.namespaceId === table.namespaceId)\n          .filter(proc => proc.name.startsWith(`${table.name}_`))\n          .filter(proc => proc.argTypeIds.length > 0)\n          .filter(proc => proc.argTypeIds[0] === tableType.id)\n          .reduce((memo, proc) => {\n            /*\n            proc =\n              { kind: 'procedure',\n                name: 'integration_webhook_secret',\n                description: null,\n                namespaceId: '6484381',\n                isStrict: false,\n                returnsSet: false,\n                isStable: true,\n                returnTypeId: '2950',\n                argTypeIds: [ '6484569' ],\n                argNames: [ 'integration' ],\n                argDefaultsNum: 0 }\n            */\n            const argTypes = proc.argTypeIds.map(\n              typeId => introspectionResultsByKind.typeById[typeId]\n            );\n            if (\n              argTypes\n                .slice(1)\n                .some(\n                  type =>\n                    type.type === \"c\" && type.class && type.class.isSelectable\n                )\n            ) {\n              // Accepts two input tables? Skip.\n              return memo;\n            }\n\n            const pseudoColumnName = proc.name.substr(table.name.length + 1);\n            const fieldName = inflection.column(\n              pseudoColumnName,\n              table.name,\n              table.namespace.name\n            );\n            memo[fieldName] = makeProcField(fieldName, proc, build, {\n              fieldWithHooks,\n              computed: true,\n            });\n            return memo;\n          }, {}),\n        `Adding computed column to '${Self.name}'`\n      );\n    }\n  );\n}: Plugin);\n"]}